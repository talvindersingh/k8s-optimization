{
  "name": "eval-transform-loop",
  "code_type": "kubernetes",
  "vars": {
    "subjective_pass_score": 0.9,
    "max_subjective_iterations": 3,
    "subjective_iteration_count": 1,
    "last_subjective_iteration": 0,
    "max_code_iterations": 5,
    "code_iteration_count": 1,
    "latest_manifest_key": "original_manifest"
  },
  "flow": [
    {
      "id": "resume-check",
      "type": "conditional",
      "branches": [
        {
          "value": "optimization_flow.subjective_evaluation_{{last_subjective_iteration}}.scores.weighted_overall_score",
          "condition": {
            "op": ">=",
            "compare_to": "{{subjective_pass_score}}"
          },
          "goto": "END"
        },
        {
          "value": "{{last_subjective_iteration}}",
          "condition": {
            "op": ">=",
            "compare_to": "{{max_subjective_iterations}}"
          },
          "goto": "END"
        }
      ],
      "else": "subjective-eval"
    },
    {
      "id": "subjective-eval",
      "type": "execute",
      "skipIfOutputPresent": true,
      "node": "ansible_optimizer.ansible_nodes.subjective_evaluator_agent.SubjectiveEvaluatorNode",
      "inputs": {
        "instruction": "instruction",
        "manifest": "{{latest_manifest_key}}"
      },
      "outputs": {
        "result": "optimization_flow.subjective_evaluation_{{subjective_iteration_count}}",
        "instruction_key": "instruction",
        "manifest_key": "{{latest_manifest_key}}",
        "iteration_index": "{{subjective_iteration_count}}",
        "vars.last_subjective_iteration": "{{subjective_iteration_count}}",
        "vars.subjective_iteration_count": "{{++subjective_iteration_count}}"
      }
    },
    {
      "id": "check-subjective-pass",
      "type": "conditional",
      "branches": [
        {
          "value": "optimization_flow.subjective_evaluation_{{last_subjective_iteration}}.scores.weighted_overall_score",
          "condition": {
            "op": ">=",
            "compare_to": "{{subjective_pass_score}}"
          },
          "goto": "END"
        },
        {
          "value": "{{code_iteration_count}}",
          "condition": {
            "op": ">",
            "compare_to": "{{max_code_iterations}}"
          },
          "goto": "END"
        }
      ],
      "else": "manifest-optimizer"
    },
    {
      "id": "manifest-optimizer",
      "type": "execute",
      "skipIfOutputPresent": true,
      "node": "ansible_optimizer.ansible_nodes.kubernetes_manifest_optimizer_agent.KubernetesManifestOptimizerNode",
      "inputs": {
        "instruction": "instruction",
        "before_manifest": "{{latest_manifest_key}}",
        "feedback": "optimization_flow.subjective_evaluation_{{last_subjective_iteration}}.scores",
        "max_turns": "12"
      },
      "outputs": {
        "result": "optimization_flow.improved_manifest_B{{code_iteration_count}}",
        "instruction_key": "instruction",
        "before_manifest_key": "{{latest_manifest_key}}",
        "feedback_key": "optimization_flow.subjective_evaluation_{{last_subjective_iteration}}.scores",
        "iteration_index": "{{code_iteration_count}}",
        "vars.latest_manifest_key": "optimization_flow.improved_manifest_B{{code_iteration_count}}.code",
        "vars.code_iteration_count": "{{++code_iteration_count}}"
      }
    },
    {
      "id": "loop-continue",
      "type": "conditional",
      "branches": [
        {
          "value": "{{subjective_iteration_count}}",
          "condition": {
            "op": ">",
            "compare_to": "{{max_subjective_iterations}}"
          },
          "goto": "END"
        }
      ],
      "else": "resume-check"
    }
  ]
}
